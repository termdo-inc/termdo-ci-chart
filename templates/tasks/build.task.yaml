apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-task
spec:
  params:
    - name: artifact
      type: string
      description: Name of the artifact (image tarball)
  workspaces:
    - name: source
      description: Workspace containing the repository
      readOnly: true
    - name: cache
      description: Workspace for caching image layers
      readOnly: true
    - name: artifacts
      description: Workspace to store the built image tarball
  steps:
    - name: build
      image: moby/buildkit:latest
      securityContext:
        privileged: true
        appArmorProfile:
          type: Unconfined
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        set -e

        echo "[‚è≥]: Checking for BuildKit cache..."
        if [ ! -f "$(workspaces.cache.path)/index.json" ]; then
          echo -e "[üü†]: No cache found in '$(workspaces.cache.path)'.\n"
        else
          echo -e "[üü¢]: Cache found in '$(workspaces.cache.path)'.\n"
        fi

        echo -e "[‚è≥]: Building the image..."
        buildctl-daemonless.sh build \
          --frontend dockerfile.v0 \
          --local context="." \
          --local dockerfile="." \
          --import-cache type=local,src=$(workspaces.cache.path) \
          --output type=oci,dest="$(workspaces.artifacts.path)/$(params.artifact)"
        echo -e "[üü¢]: Image built and saved to '$(workspaces.artifacts.path)/$(params.artifact)'.\n"
